<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3Dç‚«å…‰ä¸Šå¤´å°çƒ Â· æ·±æµ·è“é»˜è®¤ç‰ˆ</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    background:#000;
    overflow:hidden;
    font-family:Arial, sans-serif;
    cursor:none;
    user-select:none;
}
/* é€šç”¨èœå•æ ·å¼ */
.menu{
    position:fixed;
    top:0;left:0;
    width:100vw;height:100vh;
    background:radial-gradient(circle at center,#101025 0%,#000 80%);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:9999;
    color:#fff;
}
.menu h1{
    font-size:48px;
    color:#0ff;
    text-shadow:0 0 20px #0ff,0 0 40px #0ff;
    margin-bottom:40px;
}
.menu h2{
    font-size:36px;
    color:#0ff;
    text-shadow:0 0 15px #0ff;
    margin-bottom:30px;
}
.menu-btn{
    width:280px;
    padding:16px 0;
    margin:10px 0;
    font-size:20px;
    font-weight:bold;
    border:none;
    border-radius:12px;
    cursor:pointer;
    transition:all 0.2s;
}
.menu-btn.primary{
    background:#0ff;
    color:#000;
    box-shadow:0 0 20px #0ff;
}
.menu-btn.secondary{
    background:#ff2266;
    color:#fff;
    box-shadow:0 0 20px #ff2266;
}
.menu-btn.tertiary{
    background:#8844ff;
    color:#fff;
    box-shadow:0 0 20px #8844ff;
}
.menu-btn.gold{
    background:#ffd700;
    color:#000;
    box-shadow:0 0 20px #ffd700;
}
.menu-btn:hover{transform:scale(1.05)}
.menu-btn:active{transform:scale(0.95)}
.menu-btn:disabled{
    background:#333;
    box-shadow:none;
    opacity:0.5;
    cursor:not-allowed;
    transform:none;
}
.gold-display{
    position:absolute;
    top:20px;
    right:20px;
    font-size:24px;
    font-weight:bold;
    color:#ffd700;
    text-shadow:0 0 10px #ffd700;
}
.score-display{
    position:absolute;
    top:60px;
    right:20px;
    font-size:20px;
    font-weight:bold;
    color:#0ff;
    text-shadow:0 0 10px #0ff;
}
.back-btn{
    position:absolute;
    top:20px;
    left:20px;
    padding:10px 20px;
    background:#333;
    color:#fff;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-size:16px;
}
.back-btn:hover{background:#555}
.toast{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.9);
    padding:15px 30px;
    border-radius:10px;
    color:#fff;
    font-size:18px;
    z-index:99999;
    display:none;
}

/* çš®è‚¤èœå• */
.skin-list{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:20px;
    margin:30px 0;
}
.skin-item{
    width:120px;
    padding:15px;
    background:rgba(255,255,255,0.1);
    border-radius:12px;
    text-align:center;
    border:2px solid transparent;
}
.skin-item.active{
    border-color:#0ff;
    box-shadow:0 0 15px #0ff;
}
.skin-preview{
    width:60px;
    height:60px;
    border-radius:50%;
    margin:0 auto 10px;
}
.skin-name{
    font-size:14px;
    margin-bottom:8px;
}
.skin-btn{
    width:100%;
    padding:6px 0;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-size:12px;
    font-weight:bold;
}

/* é‡‘å¸å…‘æ¢èœå• */
.exchange-box{
    width:320px;
    background:rgba(255,255,255,0.1);
    padding:30px;
    border-radius:15px;
    border:2px solid #ffd700;
    text-align:center;
    margin:20px 0;
}
.exchange-rule{
    font-size:18px;
    margin-bottom:20px;
    color:#ffd700;
}
.exchange-input-box{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    margin:20px 0;
}
.exchange-input{
    width:150px;
    padding:12px;
    font-size:18px;
    border:2px solid #ffd700;
    border-radius:8px;
    background:#000;
    color:#fff;
    text-align:center;
    outline:none;
}
.exchange-input:focus{
    box-shadow:0 0 15px #ffd700;
}
.exchange-count{
    font-size:16px;
    margin:10px 0;
    color:#fff;
}

/* æ¸¸æˆç•Œé¢ */
#gameUI{display:none}
#game{
    width:100vw;
    height:100vh;
    position:relative;
    perspective:1200px;
    background:radial-gradient(circle at center,#101020 0%,#000 80%);
}
#score{
    position:fixed;
    top:20px;
    left:50%;
    transform:translateX(-50%);
    font-size:50px;
    font-weight:bold;
    color:#0ff;
    text-shadow:0 0 15px #0ff,0 0 40px #0ff;
    z-index:99;
}
#pauseBtn{
    position:fixed;
    top:20px;
    left:20px;
    width:45px;
    height:45px;
    background:rgba(255,255,255,0.2);
    border:2px solid #fff;
    border-radius:8px;
    color:#fff;
    font-size:20px;
    cursor:pointer;
    z-index:100;
    display:flex;
    align-items:center;
    justify-content:center;
}
#player{
    width:38px;
    height:38px;
    border-radius:50%;
    position:absolute;
    z-index:100;
    transform:translate(-50%,-50%);
}
.trail{
    position:absolute;
    width:12px;
    height:12px;
    border-radius:50%;
    pointer-events:none;
    opacity:0.7;
    z-index:50;
}
.obstacle{
    position:absolute;
    background:linear-gradient(90deg,#ff2266,#ff8800);
    height:24px;
    box-shadow:0 0 20px #ff2266;
    border-radius:6px;
    z-index:10;
}

/* æš‚åœ/ç»“ç®—èœå• */
.modal{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.9);
    padding:40px;
    border-radius:20px;
    border:3px solid #0ff;
    text-align:center;
    z-index:1000;
    display:none;
}
.modal h2{
    font-size:36px;
    margin-bottom:20px;
}
.modal p{
    font-size:20px;
    margin-bottom:10px;
}
.modal .menu-btn{
    width:200px;
    margin:8px 0;
}

/* åŠ¨ç”» */
@keyframes shake{
    0%{transform:translate(0,0)}
    25%{transform:translate(-6px,4px)}
    50%{transform:translate(4px,-3px)}
    75%{transform:translate(-3px,-5px)}
    100%{transform:translate(0,0)}
}
.shake{animation:shake 0.1s 4}
@keyframes pulse{
    0%{box-shadow:0 0 25px var(--skin-color),0 0 50px var(--skin-color2)}
    50%{box-shadow:0 0 40px var(--skin-color),0 0 80px var(--skin-color2)}
    100%{box-shadow:0 0 25px var(--skin-color),0 0 50px var(--skin-color2)}
}
.pulse{animation:pulse 0.4s infinite}
@keyframes toastShow{
    0%{opacity:0;transform:translate(-50%,-50%) scale(0.8)}
    50%{opacity:1;transform:translate(-50%,-50%) scale(1.05)}
    100%{opacity:1;transform:translate(-50%,-50%) scale(1)}
}
.toast.show{
    display:block;
    animation:toastShow 0.3s ease;
}
</style>
</head>
<body>

<!-- ä¸»èœå• -->
<div id="mainMenu" class="menu">
    <h1>3Dç‚«å…‰ä¸Šå¤´å°çƒ</h1>
    <button class="menu-btn primary" onclick="showDifficultyMenu()">å¼€å§‹æ¸¸æˆ</button>
    <button class="menu-btn gold" onclick="showExchangeMenu()">é‡‘å¸å…‘æ¢</button>
    <button class="menu-btn tertiary" onclick="showSkinMenu()">çš®è‚¤å…‘æ¢</button>
    <div class="gold-display">é‡‘å¸: <span id="mainGold">0</span></div>
    <div class="score-display">ç´¯è®¡å¾—åˆ†: <span id="mainScore">0</span></div>
</div>

<!-- éš¾åº¦é€‰æ‹©èœå• -->
<div id="difficultyMenu" class="menu" style="display:none">
    <h1>é€‰æ‹©éš¾åº¦</h1>
    <button class="menu-btn primary" onclick="startGame('easy')">ç®€å•æ¨¡å¼</button>
    <button class="menu-btn secondary" onclick="startGame('normal')">æ™®é€šæ¨¡å¼</button>
    <button class="menu-btn tertiary" onclick="startGame('hard')">å›°éš¾æ¨¡å¼</button>
    <button class="back-btn" onclick="showMainMenu()">è¿”å›</button>
    <div class="gold-display">é‡‘å¸: <span id="diffGold">0</span></div>
    <div class="score-display">ç´¯è®¡å¾—åˆ†: <span id="diffScore">0</span></div>
</div>

<!-- é‡‘å¸å…‘æ¢èœå• -->
<div id="exchangeMenu" class="menu" style="display:none">
    <h2>é‡‘å¸å…‘æ¢</h2>
    <button class="back-btn" onclick="showMainMenu()">è¿”å›</button>
    <div class="gold-display">é‡‘å¸: <span id="exchangeGold">0</span></div>
    <div class="score-display">ç´¯è®¡å¾—åˆ†: <span id="exchangeScore">0</span></div>
    
    <div class="exchange-box">
        <p class="exchange-rule">å…‘æ¢è§„åˆ™ï¼š5ä¸ªç´¯è®¡å¾—åˆ† = 1ä¸ªé‡‘å¸</p>
        <div class="exchange-count">
            å½“å‰å¯å…‘æ¢æœ€å¤§é‡‘å¸æ•°ï¼š<span id="maxExchange">0</span>
        </div>
        <div class="exchange-input-box">
            <input type="number" class="exchange-input" id="exchangeNum" min="1" value="1" placeholder="è¾“å…¥å…‘æ¢æ•°é‡">
            <span style="font-size:20px">ä¸ª</span>
        </div>
        <div class="exchange-count">
            éœ€æ¶ˆè€—å¾—åˆ†ï¼š<span id="needScore">5</span>
        </div>
        <button class="menu-btn gold" style="width:100%;margin:10px 0;" onclick="exchangeGold()">ç¡®è®¤å…‘æ¢</button>
        <button class="menu-btn primary" style="width:100%;margin:5px 0;" onclick="exchangeMax()">ä¸€é”®å…‘æ¢æœ€å¤§æ•°é‡</button>
    </div>
</div>

<!-- çš®è‚¤å…‘æ¢èœå• -->
<div id="skinMenu" class="menu" style="display:none">
    <h1>çš®è‚¤å…‘æ¢</h1>
    <div class="gold-display">é‡‘å¸: <span id="skinGold">0</span></div>
    <button class="back-btn" onclick="showMainMenu()">è¿”å›</button>
    <div class="skin-list" id="skinList"></div>
</div>

<!-- æ¸¸æˆç•Œé¢ -->
<div id="gameUI">
    <div id="score">0</div>
    <button id="pauseBtn" onclick="showPauseMenu()">ğŸ </button>
    <div id="game"></div>
</div>

<!-- æš‚åœèœå• -->
<div id="pauseMenu" class="modal">
    <h2>æ¸¸æˆæš‚åœ</h2>
    <button class="menu-btn primary" onclick="resumeGame()">ç»§ç»­æ¸¸æˆ</button>
    <button class="menu-btn secondary" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
    <button class="menu-btn tertiary" onclick="backToMain()">è¿”å›ä¸»é¡µé¢</button>
</div>

<!-- æ¸¸æˆç»“æŸç»“ç®—èœå• -->
<div id="gameOverMenu" class="modal">
    <h2 style="color:#ff2266">æ¸¸æˆç»“æŸ</h2>
    <p>æœ¬å±€å¾—åˆ†: <span id="finalScore">0</span></p>
    <p>ç´¯è®¡æ€»å¾—åˆ†: <span id="totalScoreShow">0</span></p>
    <p>å½“å‰é‡‘å¸: <span id="currentGoldShow">0</span></p>
    <button class="menu-btn primary" onclick="restartGame()">é‡æ–°å¼€å§‹</button>
    <button class="menu-btn tertiary" onclick="backToMain()">è¿”å›ä¸»é¡µé¢</button>
</div>

<!-- æç¤ºå¼¹çª— -->
<div id="toast" class="toast"></div>

<script>
// å…¨å±€æ¸¸æˆå˜é‡
const game = document.getElementById('game');
const scoreText = document.getElementById('score');
const pauseMenu = document.getElementById('pauseMenu');
const gameOverMenu = document.getElementById('gameOverMenu');
const mainMenu = document.getElementById('mainMenu');
const difficultyMenu = document.getElementById('difficultyMenu');
const exchangeMenu = document.getElementById('exchangeMenu');
const skinMenu = document.getElementById('skinMenu');
const gameUI = document.getElementById('gameUI');
const toast = document.getElementById('toast');

let w = innerWidth, h = innerHeight;
let player;
let score = 0;
let speed = 0;
let rotateSpeed = 0;
let playing = false;
let obstacles = [];
let px = w/2, py = h/2;
let spawnTimer = null;
let currentDifficulty = 'normal';

// çš®è‚¤é…ç½®ï¼ˆ6æ¬¾å¯å…‘æ¢çš®è‚¤ï¼Œæ·±æµ·è“é»˜è®¤è§£é”ï¼‰
const skins = [
    {
        id: 1,
        name: "æ·±æµ·è“",
        price: 10,
        color: "#0099ff",
        color2: "#0ff",
        owned: true // é»˜è®¤è§£é”
    },
    {
        id: 2,
        name: "çƒˆç„°çº¢",
        price: 20,
        color: "#ff2266",
        color2: "#ff8800",
        owned: false
    },
    {
        id: 3,
        name: "æå…‰ç´«",
        price: 30,
        color: "#8844ff",
        color2: "#cc00ff",
        owned: false
    },
    {
        id: 4,
        name: "é’è‰ç»¿",
        price: 40,
        color: "#00ff88",
        color2: "#00cc66",
        owned: false
    },
    {
        id: 5,
        name: "é»„é‡‘è€€",
        price: 50,
        color: "#ffd700",
        color2: "#ffaa00",
        owned: false
    },
    {
        id: 6,
        name: "å¹»å½©ç™½",
        price: 60,
        color: "#ffffff",
        color2: "#ddddff",
        owned: false
    }
];

// é»˜è®¤çš®è‚¤æ”¹ä¸ºæ·±æµ·è“
let currentSkin = skins.find(skin => skin.id === 1);

// ç”¨æˆ·æ•°æ®ï¼ˆæœ¬åœ°å­˜å‚¨ï¼Œæ°¸ä¹…ä¿å­˜ï¼‰
let userData = {
    gold: 0,
    totalScore: 0,
    ownedSkins: [1], // é»˜è®¤æ‹¥æœ‰æ·±æµ·è“
    currentSkinId: 1 // é»˜è®¤ä½¿ç”¨æ·±æµ·è“
};

// éš¾åº¦é…ç½®
const difficultyConfig = {
    easy: {
        initSpeed: 4,
        speedGain: 0.08,
        rotateGain: 0.1,
        spawnInterval: 800
    },
    normal: {
        initSpeed: 7,
        speedGain: 0.15,
        rotateGain: 0.2,
        spawnInterval: 500
    },
    hard: {
        initSpeed: 10,
        speedGain: 0.22,
        rotateGain: 0.35,
        spawnInterval: 350
    }
};

// å®‰å…¨æ•°å€¼è½¬æ¢å‡½æ•°ï¼Œç¡®ä¿æ°¸è¿œè¿”å›åˆæ³•æ•°å­—
function safeNumber(num, defaultValue = 0) {
    const n = Number(num);
    return isNaN(n) ? defaultValue : n;
}

// åˆå§‹åŒ–ï¼šè¯»å–æœ¬åœ°å­˜å‚¨æ•°æ®ï¼Œå½»åº•ä¿®å¤NaNé—®é¢˜
function init() {
    try {
        const saveData = localStorage.getItem('ballGameSave');
        if(saveData) {
            const parseData = JSON.parse(saveData);
            // å¼ºåˆ¶è½¬æ¢æ‰€æœ‰æ•°å€¼å­—æ®µï¼Œå…œåº•é»˜è®¤å€¼ï¼Œå½»åº•é¿å…NaN
            userData = {
                gold: safeNumber(parseData.gold, 0),
                totalScore: safeNumber(parseData.totalScore, 0),
                ownedSkins: Array.isArray(parseData.ownedSkins) ? parseData.ownedSkins : [1],
                currentSkinId: safeNumber(parseData.currentSkinId, 1)
            };
            // å¼ºåˆ¶ç¡®ä¿æ·±æµ·è“å§‹ç»ˆæ˜¯è§£é”çŠ¶æ€
            if(!userData.ownedSkins.includes(1)) {
                userData.ownedSkins.push(1);
            }
            // æ›´æ–°å·²æ‹¥æœ‰çš®è‚¤
            skins.forEach(skin => {
                skin.owned = userData.ownedSkins.includes(skin.id);
            });
            // æ›´æ–°å½“å‰çš®è‚¤
            const skin = skins.find(s => s.id === userData.currentSkinId);
            if(skin) {
                currentSkin = skin;
            } else {
                // å¦‚æœæ‰¾ä¸åˆ°çš®è‚¤ï¼Œé»˜è®¤ç”¨æ·±æµ·è“
                currentSkin = skins.find(s => s.id === 1);
                userData.currentSkinId = 1;
            }
        }
    } catch (e) {
        // æœ¬åœ°å­˜å‚¨æ•°æ®å¼‚å¸¸æ—¶ï¼Œé‡ç½®ä¸ºé»˜è®¤æ•°æ®ï¼Œé¿å…å´©æºƒ
        userData = {
            gold: 0,
            totalScore: 0,
            ownedSkins: [1],
            currentSkinId: 1
        };
        localStorage.removeItem('ballGameSave');
    }
    updateAllDataDisplay();
    renderSkinList();
    initExchangeInput();
}

// æç¤ºå¼¹çª—
function showToast(text, duration=2000) {
    toast.innerText = text;
    toast.classList.add('show');
    setTimeout(() => {
        toast.classList.remove('show');
    }, duration);
}

// æ›´æ–°æ‰€æœ‰æ•°æ®æ˜¾ç¤º
function updateAllDataDisplay() {
    // ç¡®ä¿æ‰€æœ‰æ˜¾ç¤ºçš„æ•°å€¼éƒ½æ˜¯åˆæ³•æ•°å­—
    const safeGold = safeNumber(userData.gold);
    const safeTotalScore = safeNumber(userData.totalScore);
    const maxExchange = Math.floor(safeTotalScore / 5);

    // é‡‘å¸æ˜¾ç¤º
    document.querySelectorAll('#mainGold, #diffGold, #exchangeGold, #skinGold, #currentGoldShow').forEach(el => {
        el.innerText = safeGold;
    });
    // ç´¯è®¡å¾—åˆ†æ˜¾ç¤º
    document.querySelectorAll('#mainScore, #diffScore, #exchangeScore, #totalScoreShow').forEach(el => {
        el.innerText = safeTotalScore;
    });
    // æœ€å¤§å¯å…‘æ¢æ•°é‡
    document.getElementById('maxExchange').innerText = maxExchange;
}

// åˆå§‹åŒ–å…‘æ¢è¾“å…¥æ¡†
function initExchangeInput() {
    const exchangeNum = document.getElementById('exchangeNum');
    const needScore = document.getElementById('needScore');
    
    exchangeNum.addEventListener('input', () => {
        let num = safeNumber(exchangeNum.value, 1);
        num = Math.max(1, num);
        exchangeNum.value = num;
        needScore.innerText = num * 5;
    });
}

// é‡‘å¸å…‘æ¢æ ¸å¿ƒé€»è¾‘
function exchangeGold() {
    const exchangeNum = safeNumber(document.getElementById('exchangeNum').value, 0);
    const needScore = exchangeNum * 5;
    const safeTotalScore = safeNumber(userData.totalScore);
    
    // æ ¡éªŒ
    if(exchangeNum < 1) {
        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å…‘æ¢æ•°é‡');
        return;
    }
    if(needScore > safeTotalScore) {
        showToast('ç´¯è®¡å¾—åˆ†ä¸è¶³ï¼Œæ— æ³•å…‘æ¢');
        return;
    }
    
    // æ‰§è¡Œå…‘æ¢ï¼Œç¡®ä¿æ•°å€¼å®‰å…¨
    userData.totalScore = safeNumber(safeTotalScore - needScore);
    userData.gold = safeNumber(userData.gold + exchangeNum);
    saveUserData();
    updateAllDataDisplay();
    showToast(`å…‘æ¢æˆåŠŸï¼è·å¾— ${exchangeNum} ä¸ªé‡‘å¸`);
}

// ä¸€é”®å…‘æ¢æœ€å¤§æ•°é‡
function exchangeMax() {
    const safeTotalScore = safeNumber(userData.totalScore);
    const maxExchange = Math.floor(safeTotalScore / 5);
    if(maxExchange < 1) {
        showToast('æ²¡æœ‰å¯å…‘æ¢çš„é‡‘å¸');
        return;
    }
    
    const needScore = maxExchange * 5;
    userData.totalScore = safeNumber(safeTotalScore - needScore);
    userData.gold = safeNumber(userData.gold + maxExchange);
    saveUserData();
    updateAllDataDisplay();
    showToast(`ä¸€é”®å…‘æ¢æˆåŠŸï¼è·å¾— ${maxExchange} ä¸ªé‡‘å¸`);
}

// æ¸²æŸ“çš®è‚¤åˆ—è¡¨
function renderSkinList() {
    const skinList = document.getElementById('skinList');
    skinList.innerHTML = '';
    const safeGold = safeNumber(userData.gold);
    skins.forEach(skin => {
        const isActive = currentSkin.id === skin.id;
        const item = document.createElement('div');
        item.className = `skin-item ${isActive ? 'active' : ''}`;
        item.innerHTML = `
            <div class="skin-preview" style="background:radial-gradient(circle,${skin.color2},${skin.color});box-shadow:0 0 15px ${skin.color}"></div>
            <div class="skin-name">${skin.name}</div>
        `;
        const btn = document.createElement('button');
        btn.className = 'skin-btn';
        
        if(skin.owned) {
            btn.innerText = isActive ? 'ä½¿ç”¨ä¸­' : 'ä½¿ç”¨';
            btn.style.background = isActive ? '#0ff' : '#333';
            btn.style.color = '#000';
            btn.onclick = () => useSkin(skin);
        } else {
            btn.innerText = `${skin.price} é‡‘å¸å…‘æ¢`;
            btn.style.background = '#ffd700';
            btn.style.color = '#000';
            btn.disabled = safeGold < skin.price;
            btn.onclick = () => buySkin(skin);
        }
        item.appendChild(btn);
        skinList.appendChild(item);
    });
}

// è´­ä¹°çš®è‚¤
function buySkin(skin) {
    const safeGold = safeNumber(userData.gold);
    if(safeGold >= skin.price && !skin.owned) {
        userData.gold = safeNumber(safeGold - skin.price);
        skin.owned = true;
        userData.ownedSkins.push(skin.id);
        saveUserData();
        updateAllDataDisplay();
        renderSkinList();
        showToast(`æˆåŠŸè´­ä¹°ã€${skin.name}ã€‘çš®è‚¤ï¼`);
    }
}

// ä½¿ç”¨çš®è‚¤
function useSkin(skin) {
    if(skin.owned) {
        currentSkin = skin;
        userData.currentSkinId = skin.id;
        saveUserData();
        renderSkinList();
        showToast(`å·²åˆ‡æ¢ä¸ºã€${skin.name}ã€‘çš®è‚¤ï¼`);
    }
}

// ä¿å­˜ç”¨æˆ·æ•°æ®åˆ°æœ¬åœ°
function saveUserData() {
    try {
        localStorage.setItem('ballGameSave', JSON.stringify(userData));
    } catch (e) {
        showToast('æ•°æ®ä¿å­˜å¤±è´¥', 1500);
    }
}

// é¡µé¢åˆ‡æ¢å‡½æ•°
function showMainMenu() {
    hideAll();
    mainMenu.style.display = 'flex';
    resetGame();
    updateAllDataDisplay();
}
function showDifficultyMenu() {
    hideAll();
    difficultyMenu.style.display = 'flex';
    updateAllDataDisplay();
}
function showExchangeMenu() {
    hideAll();
    exchangeMenu.style.display = 'flex';
    updateAllDataDisplay();
}
function showSkinMenu() {
    hideAll();
    skinMenu.style.display = 'flex';
    updateAllDataDisplay();
}
function showGame() {
    hideAll();
    gameUI.style.display = 'block';
}
function showPauseMenu() {
    playing = false;
    pauseMenu.style.display = 'block';
}
function showGameOverMenu() {
    playing = false;
    gameOverMenu.style.display = 'block';
}
function hideAll() {
    mainMenu.style.display = 'none';
    difficultyMenu.style.display = 'none';
    exchangeMenu.style.display = 'none';
    skinMenu.style.display = 'none';
    gameUI.style.display = 'none';
    pauseMenu.style.display = 'none';
    gameOverMenu.style.display = 'none';
}

// é¼ æ ‡/è§¦å±æ§åˆ¶
window.addEventListener('mousemove', e => {
    px = e.x;
    py = e.y;
});
window.addEventListener('touchmove', e => {
    e.preventDefault();
    px = e.touches[0].clientX;
    py = e.touches[0].clientY;
});

// å°çƒæ‹–å°¾ç‰¹æ•ˆ
function createTrail(x,y) {
    const t = document.createElement('div');
    t.className = 'trail';
    t.style.left = x + 'px';
    t.style.top = y + 'px';
    t.style.background = currentSkin.color;
    t.style.boxShadow = `0 0 10px ${currentSkin.color}`;
    game.appendChild(t);
    setTimeout(() => {
        t.style.opacity = '0';
        setTimeout(() => t.remove(), 200);
    }, 200);
}

// åˆ›å»ºç©å®¶å°çƒ
function createPlayer() {
    if(player) player.remove();
    player = document.createElement('div');
    player.id = 'player';
    player.classList.add('pulse');
    player.style.background = `radial-gradient(circle,${currentSkin.color2},${currentSkin.color})`;
    player.style.boxShadow = `0 0 30px ${currentSkin.color},0 0 60px ${currentSkin.color2}`;
    player.style.setProperty('--skin-color', currentSkin.color);
    player.style.setProperty('--skin-color2', currentSkin.color2);
    game.appendChild(player);
}

// åˆ›å»ºéšœç¢
function spawnObstacle() {
    if(!playing) return;
    const o = document.createElement('div');
    o.className = 'obstacle';
    o.style.width = (Math.random() * 200 + 120) + 'px';
    o.style.left = Math.random() * (w - 220) + 'px';
    o.style.top = '-60px';
    game.appendChild(o);
    obstacles.push(o);
}

// æ¸¸æˆä¸»å¾ªç¯
function update() {
    if(!playing) return;

    // æ›´æ–°å°çƒä½ç½®
    player.style.left = px + 'px';
    player.style.top = py + 'px';
    createTrail(px, py);

    // ç§»åŠ¨å’Œæ›´æ–°éšœç¢
    for(let i = 0; i < obstacles.length; i++) {
        const o = obstacles[i];
        let y = parseFloat(o.style.top);
        y += speed;
        o.style.top = y + 'px';
        o.style.transform = `rotate(${rotateSpeed}deg)`;

        // éšœç¢å‡ºå±ï¼ŒåŠ åˆ†+æå‡éš¾åº¦
        if(y > h) {
            o.remove();
            obstacles.splice(i, 1);
            i--;
            score++;
            scoreText.innerText = score;
            // éš¾åº¦æå‡
            speed += difficultyConfig[currentDifficulty].speedGain;
            rotateSpeed += difficultyConfig[currentDifficulty].rotateGain;
        }

        // ç¢°æ’æ£€æµ‹
        const pr = player.getBoundingClientRect();
        const or = o.getBoundingClientRect();
        if(
            pr.right > or.left + 8 &&
            pr.left < or.right - 8 &&
            pr.bottom > or.top + 8 &&
            pr.top < or.bottom - 8
        ) {
            gameOver();
            return;
        }
    }

    requestAnimationFrame(update);
}

// å¼€å§‹æ¸¸æˆ
function startGame(difficulty) {
    currentDifficulty = difficulty;
    const config = difficultyConfig[difficulty];
    
    // é‡ç½®æ¸¸æˆçŠ¶æ€
    resetGame();
    showGame();
    
    // åˆå§‹åŒ–æ¸¸æˆå‚æ•°
    speed = config.initSpeed;
    rotateSpeed = 0;
    score = 0;
    scoreText.innerText = score;
    playing = true;

    // åˆ›å»ºç©å®¶
    createPlayer();

    // å¯åŠ¨éšœç¢ç”Ÿæˆå®šæ—¶å™¨
    spawnTimer = setInterval(spawnObstacle, config.spawnInterval);

    // å¯åŠ¨æ¸¸æˆå¾ªç¯
    update();
}

// ç»§ç»­æ¸¸æˆ
function resumeGame() {
    pauseMenu.style.display = 'none';
    playing = true;
    update();
}

// é‡æ–°å¼€å§‹æ¸¸æˆ
function restartGame() {
    pauseMenu.style.display = 'none';
    gameOverMenu.style.display = 'none';
    startGame(currentDifficulty);
}

// æ¸¸æˆç»“æŸ
function gameOver() {
    playing = false;
    clearInterval(spawnTimer);
    document.body.classList.add('shake');

    // ç´¯è®¡æœ¬å±€å¾—åˆ†åˆ°æ€»å¾—åˆ†ï¼Œç¡®ä¿æ•°å€¼å®‰å…¨
    userData.totalScore = safeNumber(userData.totalScore + score);
    saveUserData();
    updateAllDataDisplay();

    // æ›´æ–°ç»“ç®—é¡µé¢
    document.getElementById('finalScore').innerText = score;
    showGameOverMenu();

    setTimeout(() => document.body.classList.remove('shake'), 400);
}

// è¿”å›ä¸»èœå•
function backToMain() {
    resetGame();
    showMainMenu();
}

// é‡ç½®æ¸¸æˆ
function resetGame() {
    playing = false;
    clearInterval(spawnTimer);
    // æ¸…ç©ºæ‰€æœ‰éšœç¢å’Œæ‹–å°¾
    obstacles.forEach(o => o.remove());
    document.querySelectorAll('.trail').forEach(t => t.remove());
    obstacles = [];
    // é‡ç½®å‚æ•°
    score = 0;
    speed = 0;
    rotateSpeed = 0;
    scoreText.innerText = 0;
}

// çª—å£å¤§å°é€‚é…
window.addEventListener('resize', () => {
    w = innerWidth;
    h = innerHeight;
});

// åˆå§‹åŒ–æ¸¸æˆ
init();
</script>
</body>
</html>
